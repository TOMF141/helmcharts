name: Publish Helm Charts to ACR

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
  workflow_dispatch:
    inputs:
      chart_name:
        description: 'Specific chart to publish (leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (no actual push)'
        required: false
        type: boolean
        default: false

env:
  HELM_VERSION: '3.13.0'

jobs:
  publish:
    name: Publish to Azure Container Registry
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}
      
      - name: Verify Helm installation
        run: |
          helm version
          echo "Helm OCI support is enabled by default in Helm 3.8.0+"
      
      - name: Login to Azure Container Registry
        run: |
          helm registry login ${{ secrets.ACR_NAME }}.azurecr.io \
            --username ${{ secrets.ACR_USERNAME }} \
            --password ${{ secrets.ACR_PASSWORD }}
      
      - name: Detect changed charts
        id: changed
        if: github.event_name == 'push'
        run: |
          # Get list of changed charts
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^charts/' || true)
          
          if [ -z "$changed_files" ]; then
            echo "No chart changes detected"
            echo "charts=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract unique chart names
          charts=$(echo "$changed_files" | cut -d'/' -f2 | sort -u | tr '\n' ' ')
          echo "Changed charts: $charts"
          echo "charts=$charts" >> $GITHUB_OUTPUT
      
      - name: Publish all charts
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.chart_name == '' &&
          github.event.inputs.dry_run == 'false'
        run: |
          chmod +x ./publish-to-acr.sh
          ./publish-to-acr.sh --registry ${{ secrets.ACR_NAME }}
      
      - name: Publish specific chart (manual trigger)
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.chart_name != '' &&
          github.event.inputs.dry_run == 'false'
        run: |
          chmod +x ./publish-to-acr.sh
          ./publish-to-acr.sh \
            --registry ${{ secrets.ACR_NAME }} \
            --chart ${{ github.event.inputs.chart_name }}
      
      - name: Dry run
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.dry_run == 'true'
        run: |
          chmod +x ./publish-to-acr.sh
          if [ -n "${{ github.event.inputs.chart_name }}" ]; then
            ./publish-to-acr.sh \
              --registry ${{ secrets.ACR_NAME }} \
              --chart ${{ github.event.inputs.chart_name }} \
              --dry-run
          else
            ./publish-to-acr.sh \
              --registry ${{ secrets.ACR_NAME }} \
              --dry-run
          fi
      
      - name: Publish changed charts (auto trigger)
        if: |
          github.event_name == 'push' && 
          steps.changed.outputs.charts != ''
        run: |
          chmod +x ./publish-to-acr.sh
          
          for chart in ${{ steps.changed.outputs.charts }}; do
            echo "Publishing $chart..."
            ./publish-to-acr.sh \
              --registry ${{ secrets.ACR_NAME }} \
              --chart $chart
          done
      
      - name: Verify published charts
        if: success()
        run: |
          echo "Verifying charts in ACR..."
          
          # Note: This requires Azure CLI and proper authentication
          # Uncomment if you want to verify via Azure CLI
          # az acr repository list --name ${{ secrets.ACR_NAME }} --output table
          
          echo "Charts published successfully!"
          echo "View at: https://portal.azure.com/#view/Microsoft_Azure_ContainerRegistries/RepositoryBlade/registryName/${{ secrets.ACR_NAME }}"
      
      - name: Summary
        if: always()
        run: |
          echo "## Helm Chart Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ secrets.ACR_NAME }}.azurecr.io" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** helm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Trigger:** Manual" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ github.event.inputs.chart_name }}" ]; then
              echo "**Chart:** ${{ github.event.inputs.chart_name }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Chart:** All charts" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              echo "**Mode:** Dry run (no actual push)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Trigger:** Push to main" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.changed.outputs.charts }}" ]; then
              echo "**Changed charts:** ${{ steps.changed.outputs.charts }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Changed charts:** None" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
